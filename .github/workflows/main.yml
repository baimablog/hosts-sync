name: 同步多源 hosts 并推送到 Gitee

on:
  schedule:
    # 北京时间 23:00 = UTC 15:00
    - cron: "0 15 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          # 需要完整历史，否则无法 push
          fetch-depth: 0

      - name: 下载各源 hosts
        run: |
          for name in $(jq -r 'keys[]' sources.json); do
            url=$(jq -r ".[\"$name\"]" sources.json)
            echo ">>> 获取 $name  from $url"
            curl -fsSL "$url" -o "$name" || echo "# 下载失败：$name" > "$name"
            echo -e "\n# Update: $(date '+%F %T')\n# Source: $url" >> "$name"
          done

      - name: 提交到 GitHub
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || (
            git commit -m "chore: auto update hosts $(date '+%m%d-%H%M')"
            git push origin HEAD:${{ github.ref_name }}
          )

      # 一键推到 Gitee
      - name: 安装 SSH 密钥
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.GITEE_PRIVATE_KEY }}
          name: gitee_key
          known_hosts: unnecessary

      - name: 推送镜像到 Gitee
        run: |
          git remote set-url --add --push origin git@gitee.com:${{ github.repository }}.git
          git push origin HEAD:${{ github.ref_name }}

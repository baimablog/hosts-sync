name: 同步多源 hosts 并推送到 Gitee

on:
  schedule:
    # 下面这一行会被脚本动态改成 UTC 时间，无需手动算
    - cron: "0 15 * * *"
  workflow_dispatch:
    inputs:
      run_now:
        description: "立即运行一次"
        required: false
        default: "true"
env:
  TZ: Asia/Shanghai

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    
      - name: Checkout self
        uses: actions/checkout@v4

      - name: 读取源列表
        id: sources
        run: |
          echo "list=$(jq -r 'keys[]' sources.json | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: 下载各源 hosts
        run: |
          for name in ${{ steps.sources.outputs.list }}; do
            url=$(jq -r ".[\"$name\"]" sources.json)
            echo ">>> 获取 $name  from $url"
            curl -fsSL "$url" -o "$name" || echo "# 下载失败：$name" > "$name"
            echo -e "\n# Update: $(date '+%F %T')\n# Source: $url" >> "$name"
          done

      - name: 提交到 GitHub
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet || (
            git commit -m "chore: auto update hosts $(date '+%m%d-%H%M')"
            git push origin HEAD:${{ github.ref_name }}
          )

      - name: Mirror the Github organization repos to Gitee.
        uses: Yikun/hub-mirror-action@master
        with:
          # 支持Gitee, Github, Gitlab and Gitcode
          src: github/baimablog
          # 支持Gitee, Github, Gitlab and Gitcode
          dst: gitee/debug404
          clone_style: ssh                            
          src_key: ${{ secrets.SSH_PRIVATE_KEY }}     
          dst_key: ${{ secrets.GITEE_PRIVATE_KEY }}
          dst_token: ${{ secrets.GITEE_TOKEN }}
          static_list: ${{github.event.repository.name}}
          force_update: true
          # 支持分别设置源和目的端的类型
          src_account_type: user
          dst_account_type: user
